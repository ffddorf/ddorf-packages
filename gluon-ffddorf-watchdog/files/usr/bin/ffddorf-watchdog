#!/bin/sh
GWCHECKS=10

check_wan_state() {
    local result="false"
    if [[ "$(ip a show dev br-wan |head -n 1| cut -f9 -d' ')" == "UP" ]]; then
        result="true"
    fi
    echo ${result}
}
check_for_tunneldigger_tunnelbug() {
    local result="false"
    if [[ "$(logread |grep 'Unable to create local L2TP tunnel!' |wc -l)" != "0" ]]; then
        result="true"
    fi
    echo ${result}
}
ping_current_gw() {
    local result="false"
    local gw=$(batctl gwl |grep -e '^*' |cut -d' ' -f2)
    for i in $(seq 1 ${GWCHECKS}); do
        if [[ "$(batctl ping -c 1 ${gw})" ]]; then
            result="true"
            break
        fi
    done
    echo ${result}
}

if [[ "$(uci get tunneldigger.@broker[0].enabled)" == "1" ]] && [[ "$(check_wan_state)" == "true" ]]; then
    #Check Tunneldigger is stuck eternaly
    if [[ "$(check_for_tunneldigger_tunnelbug)" == "true" ]]; then
        /etc/init.d/tunneldigger restart
        logger -t ffddorf-watchdog "Seems that Tunneldigger can't create any tunnels. Rebooting in 5 seconds"
        sleep 5
        [[ "$(pidof sysupgrade)" == "" ]] && reboot
    fi
    #Ping the chosen gateway if there is one, restart node if its not pingable
    if [[ "$(batctl gwl |grep -e '^*' |cut -d' ' -f2)" != "" ]]; then
        if [[ "$(ping_current_gw)" == "false" ]]; then
            logger -t ffddorf-watchdog "Gateway is not pingable, suspecting issue with the node. Rebooting in 5 seconds"
            sleep 5
            [[ "$(pidof sysupgrade)" == "" ]] && reboot
        fi
    fi
fi
